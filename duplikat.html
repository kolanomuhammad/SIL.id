<!DOCTYPE html>

<html>
<head>
<title>SIL.id - Sistem Informasi Lahan</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    .leaflet-bottom.leaflet-right {
      bottom: 30px !important;
      right: 10px !important;
      
    }

      background: #f7f7f7;
    }

    #map {
      position: relative;
      z-index: 1;
    }

#title {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: #8da5c1;
  width: 300px;         /* Rasio landscape: lebar lebih dominan */
  height: 60px;        /* Tinggi sesuai rasio 16:9 */
  padding: 5px;
  border-radius: 20px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  display: flex;
  justify-content: center;
  align-items: center;
  user-select: none;
}

#title img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

    #layer-controls-btn {
      position: absolute;
      bottom: 400px; top: auto;
      left: 10px;
      z-index: 1001;
      background: white;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.15);
      user-select: none;
    }

    #layer-controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px 14px;
      max-height: 350px;
      width: 320px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.2);
      border-radius: 8px;
      display: none;
    }

    .layer-label {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 14px;
      color: #444;
    }

    .layer-label input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      cursor: pointer;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-left: 28px;
      margin-bottom: 10px;
      font-size: 13px;
      color: #333;
    }

    .legend-item img {
      width: 60px;
      height: 60px;
      border: 1px solid #ccc;
      margin-right: 12px;
      background: white;
      border-radius: 4px;
    }

    #info-table {
      position: absolute;
      top: 120px;
      right: 10px;
      width: 340px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(255 255 255 / 0.9);
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
      z-index: 1000;
      color: #222;
      user-select: text;
    }

    #info-table h3 {
      margin-top: 0;
      font-weight: 700;
      font-size: 16px;
      color: #111;
    }

    #info-table table {
      border-collapse: collapse;
      width: 100%;
    }

    #info-table table th, #info-table table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }

    #info-table table th {
      background-color: #f0f0f0;
      font-weight: 600;
    }

    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1001;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }

    #search-container input {
      padding: 6px;
      width: 220px;
    }

    #search-container button {
      padding: 6px 10px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
<div id="title">
  <a href="index.html">
    <img src="assets/images/SIL.id (2).png" alt="SIL.id - Sistem Informasi Lahan" />
  </a>
</div>
<div id="layer-controls-btn" title="Toggle Layer Controls">Layers ‚ñº</div>
<div id="layer-controls"></div>
<div id="search-container">

<!-- Pencarian Atribut -->
<div class="search-section">
<h4>üîç Pencarian Atribut</h4>
<div class="search-row">
<input id="search-input" placeholder="Cari atribut di info..." type="text"/>
<button id="search-btn">Cari</button>
<button id="clear-search-btn" title="Reset Filter">Reset</button>
</div>
</div>
<!-- Pencarian Spasial Multi-Infrastruktur -->
<div class="search-section">
<h4>üìç Pencarian Kedekatan Infrastruktur</h4>
<div class="search-row">
<select id="infrastructure-select">
<option value="">Pilih Infrastruktur...</option>
<option value="Jalan_Ngablak">üõ£Ô∏è Jalan</option>
<option value="Energi_Ngablak">‚ö° Jaringan Energi</option>
<option value="FO_Ngablak">üåê Fiber Optic</option>
<option value="Kesehatan_Ngablak">üè• Sarana Kesehatan</option>
<option value="Pendidikan_Ngablak">üéì Sarana Pendidikan</option>
<option value="Perdajas_Ngablak">üè™ Perdagangan &amp; Jasa</option>
<option value="Peribadatan_Ngablak">üïå Sarana Peribadatan</option>
<option value="Drainase_Ngablak">üåä Drainase</option>
<option value="Irigasi_Ngablak">üíß Irigasi</option>
</select>
</div>
<div class="search-row">
<input id="distance-input" max="5000" min="1" placeholder="Jarak" type="number" value="50"/>
<select id="distance-unit">
<option value="meters">meter</option>
<option value="kilometers">km</option>
</select>
<button id="spatial-search-btn">Filter</button>
<button id="clear-spatial-btn">Reset</button>
</div>
<div style="font-size: 11px; color: #666; margin-top: 4px;">
      Tampilkan bidang dalam radius tertentu dari infrastruktur
    </div>
</div>
</div>
<div id="map"></div>
<div id="reset-view-btn" title="Kembali ke Lokasi Awal" 
  style="position: absolute; bottom: 200px; right: 10px; z-index: 1002; 
  background: white; padding: 6px 10px; border-radius: 5px; 
  box-shadow: 0 1px 5px rgba(0,0,0,0.2); cursor: pointer;">
  üìç
</div>

<div id="info-table"><div id="process-log" style="margin-top:10px; font-size:12px; color:#555;"></div><h3>Informasi Atribut:</h3><p>Klik pada peta untuk melihat informasi atribut layer aktif.</p></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.min.js"></script>
<script>
  const map = L.map('map').setView([-7.324929, 110.621435], 16);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

document.getElementById('reset-view-btn').addEventListener('click', function() {
  map.flyTo([-7.324929, 110.621435], 16, {
    animate: true,
    duration: 1.5
  });
});

  const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, NAIP'
});

const baseMaps = {
  "OpenStreetMap HOT": osm,
  "Esri World Imagery": satellite
};
L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

document.getElementById('reset-view-btn').addEventListener('click', function() {
  map.flyTo([-7.324929, 110.621435], 16, {
    animate: true,
    duration: 1.5
  });
});

  const layerNames = [
    "Batas_Ngablak", "Drainase_Ngablak", "Energi_Ngablak", "FO_Ngablak", "Irigasi_Ngablak",
    "Jalan_Ngablak", "Kesehatan_Ngablak", "NGABLAK", "PPL_Ngablak", "Pendidikan_Ngablak",
    "Perdajas_Ngablak", "Peribadatan_Ngablak"
  ];

  const layers = {};
  const workspace = "Bidang_Ngablak";
  const geoserverUrl = "http://localhost:8080/geoserver";
  const layerControlsContainer = document.getElementById('layer-controls');

  function legendUrl(layerName) {
    return `${geoserverUrl}/${workspace}/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${workspace}:${layerName}`;
  }

  layerNames.forEach(name => {
    const fullLayerName = `${workspace}:${name}`;
    const wmsLayer = L.tileLayer.wms(`${geoserverUrl}/${workspace}/wms`, {
      layers: fullLayerName,
      format: 'image/png',
      transparent: true,
      version: '1.1.1',
      attribution: name
    });
    wmsLayer.setZIndex(500);  // üí° memaksa layer SHP di atas
    layers[name] = wmsLayer;

    const label = document.createElement("label");
    label.className = "layer-label";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";

    const legendImg = document.createElement("img");
    legendImg.src = legendUrl(name);
    legendImg.alt = `Legenda ${name}`;
    legendImg.style.display = "none";
    legendImg.className = "legend-item";

    checkbox.onchange = function () {
      if (checkbox.checked) {
        wmsLayer.addTo(map);
        legendImg.style.display = "flex";
      } else {
        map.removeLayer(wmsLayer);
        legendImg.style.display = "none";
      }
    };

    label.appendChild(checkbox);
    label.append(" " + name);
    layerControlsContainer.appendChild(label);
    layerControlsContainer.appendChild(legendImg);
  });

  document.getElementById('layer-controls-btn').onclick = () => {
    const cont = document.getElementById('layer-controls');
    cont.style.display = cont.style.display === 'block' ? 'none' : 'block';
  };

  map.on('click', function (e) {
    const pos = map.latLngToContainerPoint(e.latlng);
    const size = map.getSize();
    const bounds = map.getBounds();
    const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;

    const activeLayers = Object.entries(layers)
      .filter(([_, layer]) => map.hasLayer(layer))
      .map(([name]) => name);

    if (activeLayers.length === 0) {
      $("#info-table").html("<h3>Informasi Atribut:</h3><p>Tidak ada layer aktif.</p>");
      return;
    }

    $("#info-table").html("<h3>Informasi Atribut:</h3>");

    activeLayers.forEach(layerName => {
      $.ajax({
        url: `${geoserverUrl}/${workspace}/wms`,
        data: {
          service: "WMS",
          version: "1.1.1",
          request: "GetFeatureInfo",
          layers: `${workspace}:${layerName}`,
          query_layers: `${workspace}:${layerName}`,
          info_format: "application/json",
          feature_count: 5,
          srs: "EPSG:4326",
          width: size.x,
          height: size.y,
          x: Math.round(pos.x),
          y: Math.round(pos.y),
          bbox: bbox
        },
        success: function (result) {
          if (result.features && result.features.length > 0) {
            const props = result.features[0].properties;
            let html = `<h4>Layer: ${layerName}</h4><table><tr><th>Atribut</th><th>Nilai</th></tr>`;
            for (const [key, value] of Object.entries(props)) {
              html += `<tr><td>${key}</td><td>${value}</td></tr>`;
            }
            html += "</table><br>";
            $("#info-table").append(html);
          }
        },
        error: function () {
          $("#info-table").append(`<p>Gagal mengambil info dari layer: ${layerName}</p>`);
        }
      });
    });
  });

  function findNearest() {
    const jalanUrl = `${geoserverUrl}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:Jalan_Ngablak&outputFormat=application/json`;
    const bidangUrl = `${geoserverUrl}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:NGABLAK&outputFormat=application/json`;

    Promise.all([
      fetch(jalanUrl).then(res => res.json()),
      fetch(bidangUrl).then(res => res.json())
    ]).then(([jalanData, bidangData]) => {
      let nearest = null;
      let minDist = Infinity;

      jalanData.features.forEach(jalan => {
        const jalanGeom = turf.feature(jalan.geometry);

        bidangData.features.forEach(bidang => {
          const bidangGeom = turf.feature(bidang.geometry);
          const dist = turf.distance(turf.center(jalanGeom), turf.center(bidangGeom), {units: 'kilometers'});

          if (dist < minDist) {
            minDist = dist;
            nearest = bidang;
          }
        });
      });

      if (nearest) {
        const geoJsonLayer = L.geoJSON(nearest.geometry, {
          style: { color: 'red', weight: 3 }
        }).addTo(map);

document.getElementById('reset-view-btn').addEventListener('click', function() {
  map.flyTo([-7.324929, 110.621435], 16, {
    animate: true,
    duration: 1.5
  });
});


        map.fitBounds(geoJsonLayer.getBounds());

        let html = `<h3>Bidang Terdekat dengan Jalan</h3><table><tr><th>Atribut</th><th>Nilai</th></tr>`;
        for (const [k, v] of Object.entries(nearest.properties)) {
          html += `<tr><td>${k}</td><td>${v}</td></tr>`;
        }
        html += `</table>`;
        document.getElementById('info-table').innerHTML = html;
      } else {
        alert("Tidak ditemukan data.");
      }
    });
  }

  L.control.measure({
    position: 'bottomright',
    primaryLengthUnit: 'meters',
    primaryAreaUnit: 'sqmeters',
    activeColor: '#db4a29',
    completedColor: '#9b2d14'
  }).addTo(map);

document.getElementById('reset-view-btn').addEventListener('click', function() {
  map.flyTo([-7.324929, 110.621435], 16, {
    animate: true,
    duration: 1.5
  });
});




// Variabel global untuk menyimpan geometri infrastruktur
let infrastructureGeometries = {};
let currentInfrastructure = '';

// Inisialisasi layer groups untuk hasil pencarian
const spatialSearchLayer = L.layerGroup().addTo(map);
const bufferLayer = L.layerGroup().addTo(map);

// GANTI FUNGSI performInfrastructureSpatialSearch YANG ADA DENGAN VERSI PERBAIKAN INI:

async function performInfrastructureSpatialSearch() {
  const selectedInfrastructure = document.getElementById('infrastructure-select').value;
  const distance = parseFloat(document.getElementById('distance-input').value);
  const unit = document.getElementById('distance-unit').value;
  
  console.log(`Memulai pencarian spasial: ${distance} ${unit} dari ${selectedInfrastructure}`);
  
  if (!selectedInfrastructure) {
    alert('Pilih jenis infrastruktur terlebih dahulu');
    return;
  }
  
  if (!distance || distance <= 0) {
    alert('Masukkan jarak yang valid');
    return;
  }

  // Bersihkan hasil pencarian sebelumnya
  spatialSearchLayer.clearLayers();
  bufferLayer.clearLayers();
  
  // Update status
  const infraName = getInfrastructureName(selectedInfrastructure);
  document.getElementById('info-table').innerHTML = 
    `<h3>Status:</h3><p>üîÑ Memproses pencarian spasial untuk ${infraName}...</p>`;

  try {
    // Konversi distance ke meter jika diperlukan
    const distanceInMeters = unit === 'kilometers' ? distance * 1000 : distance;
    console.log(`Jarak dalam meter: ${distanceInMeters}`);

    // Ambil data infrastruktur dan bidang tanah secara bersamaan
    const [infraResponse, landResponse] = await Promise.all([
      fetch(`${geoserverUrl}/${workspace}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:${selectedInfrastructure}&outputFormat=application/json&srsName=EPSG:4326`),
      fetch(`${geoserverUrl}/${workspace}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:NGABLAK&outputFormat=application/json&srsName=EPSG:4326`)
    ]);

    if (!infraResponse.ok || !landResponse.ok) {
      throw new Error(`HTTP error! Infrastructure: ${infraResponse.status}, Land: ${landResponse.status}`);
    }

    const [infraData, landData] = await Promise.all([
      infraResponse.json(),
      landResponse.json()
    ]);

    console.log(`Infrastruktur data:`, infraData);
    console.log(`Land data:`, landData);

    if (!infraData.features || infraData.features.length === 0) {
      document.getElementById('info-table').innerHTML = 
        `<h3>Info:</h3><p>‚ö†Ô∏è Tidak ada data ${infraName} ditemukan</p>`;
      return;
    }

    if (!landData.features || landData.features.length === 0) {
      document.getElementById('info-table').innerHTML = 
        `<h3>Info:</h3><p>‚ö†Ô∏è Tidak ada data bidang tanah ditemukan</p>`;
      return;
    }

    // Buat buffer dari semua geometri infrastruktur
    let allBuffers = [];
    let validInfraCount = 0;
    
    infraData.features.forEach((infraFeature, index) => {
      try {
        const infraGeometry = infraFeature.geometry;
        if (!infraGeometry || !infraGeometry.coordinates) {
          console.warn(`${selectedInfrastructure} feature ${index} tidak memiliki geometri valid`);
          return;
        }
        
        console.log(`Processing ${selectedInfrastructure} ${index}, geometry type:`, infraGeometry.type);
        
        // Validasi geometri
        let validGeometry = infraGeometry;
        
        // Untuk LineString, pastikan ada minimal 2 titik
        if (infraGeometry.type === 'LineString' && infraGeometry.coordinates.length < 2) {
          console.warn(`LineString ${index} memiliki kurang dari 2 koordinat`);
          return;
        }
        
        // Untuk Polygon, pastikan ring tertutup
        if (infraGeometry.type === 'Polygon') {
          infraGeometry.coordinates.forEach((ring, ringIndex) => {
            if (ring.length < 4) {
              console.warn(`Polygon ${index} ring ${ringIndex} memiliki kurang dari 4 koordinat`);
              return;
            }
            // Pastikan ring tertutup
            const firstPoint = ring[0];
            const lastPoint = ring[ring.length - 1];
            if (firstPoint[0] !== lastPoint[0] || firstPoint[1] !== lastPoint[1]) {
              ring.push([firstPoint[0], firstPoint[1]]);
            }
          });
        }
        
        // Buat buffer untuk setiap infrastruktur
        const buffer = turf.buffer(validGeometry, distanceInMeters, { units: 'meters' });
        if (buffer && buffer.geometry) {
          allBuffers.push(buffer);
          validInfraCount++;
        }
      } catch (error) {
        console.error(`Error processing ${selectedInfrastructure} ${index}:`, error);
      }
    });

    if (allBuffers.length === 0) {
      document.getElementById('info-table').innerHTML = 
        `<h3>Error:</h3><p>‚ùå Tidak dapat membuat buffer dari geometri ${infraName}. Periksa data geometri.</p>`;
      return;
    }

    console.log(`Berhasil membuat ${allBuffers.length} buffer dari ${validInfraCount} infrastruktur valid`);

    // Gabungkan semua buffer
    let combinedBuffer = allBuffers[0];
    for (let i = 1; i < allBuffers.length; i++) {
      try {
        combinedBuffer = turf.union(combinedBuffer, allBuffers[i]);
      } catch (error) {
        console.warn(`Error union buffer ${i}:`, error);
        // Jika union gagal, tetap gunakan buffer individual
      }
    }

    // Tampilkan buffer area di peta
    const bufferColors = {
      'Jalan_Ngablak': '#ff0000',
      'Energi_Ngablak': '#ffaa00',
      'FO_Ngablak': '#00aaff',
      'Kesehatan_Ngablak': '#ff0080',
      'Pendidikan_Ngablak': '#8000ff',
      'Perdajas_Ngablak': '#00ff80',
      'Peribadatan_Ngablak': '#ff8000',
      'Drainase_Ngablak': '#0080ff',
      'Irigasi_Ngablak': '#80ff00'
    };
    
    const bufferColor = bufferColors[selectedInfrastructure] || '#ff0000';

    // Tampilkan buffer area
    if (combinedBuffer && combinedBuffer.geometry) {
      const bufferGeoJSON = L.geoJSON(combinedBuffer, {
        style: {
          color: bufferColor,
          weight: 2,
          opacity: 0.8,
          fillColor: bufferColor,
          fillOpacity: 0.2
        }
      });
      bufferLayer.addLayer(bufferGeoJSON);
      console.log(`Buffer area ${selectedInfrastructure} ditampilkan di peta`);
    }

    // Filter bidang yang berada dalam buffer
    const filteredLands = [];
    let processedCount = 0;
    
    landData.features.forEach((landFeature, index) => {
      try {
        const landGeometry = landFeature.geometry;
        
        if (!landGeometry || !landGeometry.coordinates) {
          console.warn(`Land feature ${index} tidak memiliki geometri valid`);
          return;
        }
        
        processedCount++;
        
        if (combinedBuffer && combinedBuffer.geometry) {
          // Cek apakah bidang tanah bersinggungan dengan buffer area
          try {
            const intersection = turf.intersect(landGeometry, combinedBuffer.geometry);
            if (intersection) {
              filteredLands.push(landFeature);
              console.log(`Bidang ${index} memenuhi kriteria ${selectedInfrastructure}`);
            }
          } catch (intersectError) {
            // Jika intersect gagal, coba dengan booleanPointInPolygon untuk titik tengah
            try {
              const landCenter = turf.center(landGeometry);
              const isInside = turf.booleanPointInPolygon(landCenter, combinedBuffer.geometry);
              if (isInside) {
                filteredLands.push(landFeature);
                console.log(`Bidang ${index} (center) memenuhi kriteria ${selectedInfrastructure}`);
              }
            } catch (centerError) {
              console.warn(`Error checking land ${index}:`, intersectError, centerError);
            }
          }
        }
      } catch (error) {
        console.warn(`Error processing land ${index}:`, error);
      }
    });

    console.log(`Memproses ${processedCount} bidang tanah, ditemukan ${filteredLands.length} yang memenuhi kriteria`);

    // Tampilkan hasil di peta
    if (filteredLands.length > 0) {
      const resultGeoJSON = L.geoJSON({
        type: "FeatureCollection",
        features: filteredLands
      }, {
        style: {
          color: '#00ff00',
          weight: 3,
          opacity: 1.0,
          fillColor: '#00ff00',
          fillOpacity: 0.4
        },
        onEachFeature: function(feature, layer) {
          // Tambahkan popup dengan informasi bidang
          if (feature.properties) {
            let popupContent = `<div style="max-width: 250px;">`;
            popupContent += `<h4>üìç Informasi Bidang</h4>`;
            popupContent += `<p><strong>üèóÔ∏è Dekat dengan:</strong> ${infraName}</p>`;
            popupContent += `<p><strong>üìè Jarak:</strong> ‚â§ ${distance} ${unit}</p><hr>`;
            
            // Tampilkan atribut dengan format yang lebih baik
            Object.entries(feature.properties).forEach(([key, value]) => {
              if (value !== null && value !== undefined && value !== '') {
                popupContent += `<p><b>${key}:</b> ${value}</p>`;
              }
            });
            popupContent += `</div>`;
            layer.bindPopup(popupContent);
          }
          
          // Tambahkan highlight saat hover
          layer.on('mouseover', function() {
            this.setStyle({
              weight: 5,
              opacity: 1.0,
              fillOpacity: 0.7
            });
          });
          
          layer.on('mouseout', function() {
            this.setStyle({
              weight: 3,
              opacity: 1.0,
              fillOpacity: 0.4
            });
          });
        }
      });
      
      spatialSearchLayer.addLayer(resultGeoJSON);
      
      // Update info table dengan hasil
      let infoHtml = `<h3>üéØ Hasil Pencarian Spasial</h3>`;
      infoHtml += `<p>‚úÖ Ditemukan <b>${filteredLands.length}</b> bidang dalam radius <b>${distance} ${unit}</b> dari <b>${infraName}</b>.</p>`;
      infoHtml += `<p>üìä Diproses dari <b>${processedCount}</b> bidang tanah total.</p>`;
      
      if (filteredLands.length > 0 && filteredLands[0].properties) {
        infoHtml += `<h4>üìã Preview Data Bidang Pertama:</h4>`;
        infoHtml += `<table style="width:100%; font-size:12px;"><tr><th>Atribut</th><th>Nilai</th></tr>`;
        
        let displayCount = 0;
        Object.entries(filteredLands[0].properties).forEach(([key, value]) => {
          if (value !== null && value !== undefined && value !== '' && displayCount < 8) {
            infoHtml += `<tr><td><b>${key}</b></td><td>${value}</td></tr>`;
            displayCount++;
          }
        });
        infoHtml += `</table>`;
      }
      
      infoHtml += `<div style="margin-top:10px; padding:8px; background:#f0f0f0; border-radius:4px; font-size:11px;">`;
      infoHtml += `üí° <b>Tips:</b><br>`;
      infoHtml += `‚Ä¢ Klik area hijau untuk detail bidang<br>`;
      infoHtml += `‚Ä¢ Area merah/orange = zona buffer<br>`;
      infoHtml += `‚Ä¢ Zoom untuk melihat lebih detail`;
      infoHtml += `</div>`;
      
      document.getElementById('info-table').innerHTML = infoHtml;
      
      // Zoom ke hasil pencarian dengan padding yang cukup
      try {
        const bounds = resultGeoJSON.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds, { 
            padding: [50, 50],
            maxZoom: 18 
          });
        }
      } catch (zoomError) {
        console.warn('Error zooming to results:', zoomError);
      }
      
    } else {
      document.getElementById('info-table').innerHTML = 
        `<h3>üéØ Hasil Pencarian Spasial</h3>
        <p>‚ùå Tidak ada bidang ditemukan dalam radius <b>${distance} ${unit}</b> dari <b>${infraName}</b>.</p>
        <p>üìä Diproses ${processedCount} bidang tanah dari ${landData.features.length} total.</p>
        <div style="margin-top:10px; padding:8px; background:#fff3cd; border-radius:4px; font-size:12px;">
        üí° <b>Saran:</b><br>
        ‚Ä¢ Coba perbesar jarak pencarian<br>
        ‚Ä¢ Pastikan ada bidang tanah di sekitar ${infraName}<br>
        ‚Ä¢ Periksa apakah layer NGABLAK dan ${selectedInfrastructure} aktif
        </div>`;
    }

  } catch (error) {
    console.error('Error in infrastructure spatial search:', error);
    document.getElementById('info-table').innerHTML = 
      `<h3>‚ùå Error Pencarian Spasial</h3>
      <p>Terjadi kesalahan: <code>${error.message}</code></p>
      <div style="margin-top:10px; padding:8px; background:#f8d7da; border-radius:4px; font-size:12px;">
      üîß <b>Troubleshooting:</b><br>
      ‚Ä¢ Pastikan GeoServer berjalan di localhost:8080<br>
      ‚Ä¢ Periksa koneksi internet<br>
      ‚Ä¢ Pastikan layer ${selectedInfrastructure} dan NGABLAK tersedia<br>
      ‚Ä¢ Coba refresh halaman
      </div>`;
  }
}

// TAMBAHKAN FUNGSI PENCARIAN ATRIBUT YANG LEBIH BAIK

function performAttributeSearch() {
  const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
  
  if (!searchTerm) {
    alert('Masukkan kata kunci pencarian');
    return;
  }

  // Bersihkan hasil pencarian spasial sebelumnya
  spatialSearchLayer.clearLayers();
  bufferLayer.clearLayers();

  document.getElementById('info-table').innerHTML = 
    `<h3>Status:</h3><p>üîç Mencari atribut yang mengandung "${searchTerm}"...</p>`;

  // Ambil semua layer aktif
  const activeLayers = Object.entries(layers)
    .filter(([_, layer]) => map.hasLayer(layer))
    .map(([name]) => name);

  if (activeLayers.length === 0) {
    document.getElementById('info-table').innerHTML = 
      "<h3>Info:</h3><p>‚ö†Ô∏è Tidak ada layer aktif. Aktifkan layer terlebih dahulu.</p>";
    return;
  }

  let searchPromises = activeLayers.map(layerName => {
    return fetch(`${geoserverUrl}/${workspace}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:${layerName}&outputFormat=application/json&srsName=EPSG:4326`)
      .then(response => response.json())
      .then(data => ({ layerName, data }))
      .catch(error => ({ layerName, error }));
  });

  Promise.all(searchPromises).then(results => {
    let foundFeatures = [];
    let searchResults = {};

    results.forEach(result => {
      if (result.error) {
        console.error(`Error loading ${result.layerName}:`, result.error);
        return;
      }

      if (result.data.features) {
        result.data.features.forEach(feature => {
          if (feature.properties) {
            // Cari di semua atribut
            Object.entries(feature.properties).forEach(([key, value]) => {
              if (value && value.toString().toLowerCase().includes(searchTerm)) {
                foundFeatures.push({
                  layer: result.layerName,
                  feature: feature,
                  matchedAttribute: key,
                  matchedValue: value
                });

                if (!searchResults[result.layerName]) {
                  searchResults[result.layerName] = [];
                }
                searchResults[result.layerName].push({
                  feature: feature,
                  matchedAttribute: key,
                  matchedValue: value
                });
              }
            });
          }
        });
      }
    });

    // Tampilkan hasil
    if (foundFeatures.length > 0) {
      // Tampilkan di peta jika ada geometri
      const featuresWithGeometry = foundFeatures.filter(item => item.feature.geometry);
      
      if (featuresWithGeometry.length > 0) {
        const searchResultGeoJSON = L.geoJSON({
          type: "FeatureCollection",
          features: featuresWithGeometry.map(item => item.feature)
        }, {
          style: {
            color: '#ff6600',
            weight: 4,
            opacity: 1.0,
            fillColor: '#ff6600',
            fillOpacity: 0.3
          },
          onEachFeature: function(feature, layer) {
            const matchedItem = foundFeatures.find(item => item.feature === feature);
            let popupContent = `<div style="max-width: 250px;">`;
            popupContent += `<h4>üîç Hasil Pencarian</h4>`;
            popupContent += `<p><strong>Layer:</strong> ${matchedItem.layer}</p>`;
            popupContent += `<p><strong>Kata kunci:</strong> "${searchTerm}"</p>`;
            popupContent += `<p><strong>Ditemukan di:</strong> ${matchedItem.matchedAttribute}</p>`;
            popupContent += `<p><strong>Nilai:</strong> ${matchedItem.matchedValue}</p><hr>`;
            
            if (feature.properties) {
              Object.entries(feature.properties).forEach(([key, value]) => {
                if (value !== null && value !== undefined && value !== '') {
                  popupContent += `<p><b>${key}:</b> ${value}</p>`;
                }
              });
            }
            popupContent += `</div>`;
            layer.bindPopup(popupContent);
          }
        });
        
        spatialSearchLayer.addLayer(searchResultGeoJSON);
        
        // Zoom ke hasil
        try {
          map.fitBounds(searchResultGeoJSON.getBounds(), { padding: [20, 20] });
        } catch (e) {
          console.warn('Error zooming to search results:', e);
        }
      }

      // Update info table
      let infoHtml = `<h3>üîç Hasil Pencarian Atribut</h3>`;
      infoHtml += `<p>‚úÖ Ditemukan <b>${foundFeatures.length}</b> hasil untuk "<b>${searchTerm}</b>"</p>`;
      
      Object.entries(searchResults).forEach(([layerName, matches]) => {
        infoHtml += `<h4>üìÑ Layer: ${layerName} (${matches.length} hasil)</h4>`;
        matches.slice(0, 3).forEach((match, index) => {
          infoHtml += `<div style="background:#f8f9fa; margin:5px 0; padding:8px; border-radius:4px; font-size:12px;">`;
          infoHtml += `<b>${match.matchedAttribute}:</b> ${match.matchedValue}`;
          infoHtml += `</div>`;
        });
        if (matches.length > 3) {
          infoHtml += `<p style="font-size:11px; color:#666;">... dan ${matches.length - 3} hasil lainnya</p>`;
        }
      });

      document.getElementById('info-table').innerHTML = infoHtml;

    } else {
      document.getElementById('info-table').innerHTML = 
        `<h3>üîç Hasil Pencarian Atribut</h3>
        <p>‚ùå Tidak ditemukan hasil untuk "<b>${searchTerm}</b>"</p>
        <p>üí° Coba kata kunci lain atau pastikan layer yang diinginkan sudah aktif.</p>`;
    }
  });
}

// Event handlers untuk pencarian atribut
document.getElementById('search-btn').addEventListener('click', performAttributeSearch);
document.getElementById('search-input').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') performAttributeSearch();
});

document.getElementById('clear-search-btn').addEventListener('click', function() {
  document.getElementById('search-input').value = '';
  spatialSearchLayer.clearLayers();
  bufferLayer.clearLayers();
  document.getElementById('info-table').innerHTML = 
    "<h3>Informasi Atribut:</h3><p>Klik pada peta untuk melihat informasi atribut layer aktif.</p>";
});

// Fungsi untuk memuat geometri infrastruktur dari GeoServer
async function loadInfrastructureGeometries(layerName) {
  try {
    console.log(`Memuat geometri ${layerName}...`);
    const response = await fetch(`${geoserverUrl}/${workspace}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:${layerName}&outputFormat=application/json&srsName=EPSG:4326`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log(`Raw ${layerName} data:`, data);
    
    if (data.features && data.features.length > 0) {
      infrastructureGeometries[layerName] = data.features;
      console.log(`Berhasil memuat ${data.features.length} geometri ${layerName}`);
      
      // Tampilkan notifikasi sukses
      document.getElementById('info-table').innerHTML = 
        `<h3>Status:</h3><p>‚úÖ Berhasil memuat ${data.features.length} geometri ${layerName}. Pencarian spasial siap digunakan.</p>`;
      
      return true;
    } else {
      console.warn(`Tidak ada fitur ${layerName} ditemukan`);
      document.getElementById('info-table').innerHTML = 
        `<h3>Peringatan:</h3><p>‚ö†Ô∏è Tidak ada data ${layerName} ditemukan. Periksa layer di GeoServer.</p>`;
      return false;
    }
  } catch (error) {
    console.error(`Error loading ${layerName} geometries:`, error);
    document.getElementById('info-table').innerHTML = 
      `<h3>Error:</h3><p>‚ùå Error memuat data ${layerName}: ${error.message}</p>`;
    return false;
  }
}

// Fungsi untuk mendapatkan nama infrastruktur yang user-friendly
function getInfrastructureName(layerName) {
  const infraNames = {
    'Jalan_Ngablak': 'Jalan',
    'Energi_Ngablak': 'Jaringan Energi',
    'FO_Ngablak': 'Fiber Optic',
    'Kesehatan_Ngablak': 'Sarana Kesehatan',
    'Pendidikan_Ngablak': 'Sarana Pendidikan',
    'Perdagas_Ngablak': 'Perdagangan & Jasa',
    'Peribadatan_Ngablak': 'Sarana Peribadatan',
    'Drainase_Ngablak': 'Drainase',
    'Irigasi_Ngablak': 'Irigasi'
  };
  return infraNames[layerName] || layerName;
}

// Fungsi spatial search berdasarkan kedekatan dengan infrastruktur yang dipilih
async function performInfrastructureSpatialSearch() {
  const selectedInfrastructure = document.getElementById('infrastructure-select').value;
  const distance = parseFloat(document.getElementById('distance-input').value);
  const unit = document.getElementById('distance-unit').value;
  
  console.log(`Memulai pencarian spasial: ${distance} ${unit} dari ${selectedInfrastructure}`);
  
  if (!selectedInfrastructure) {
    alert('Pilih jenis infrastruktur terlebih dahulu');
    return;
  }
  
  if (!distance || distance <= 0) {
    alert('Masukkan jarak yang valid');
    return;
  }

  // Bersihkan hasil pencarian sebelumnya
  spatialSearchLayer.clearLayers();
  bufferLayer.clearLayers();
  
  // Update status
  const infraName = getInfrastructureName(selectedInfrastructure);
  document.getElementById('info-table').innerHTML = 
    `<h3>Status:</h3><p>üîÑ Memproses pencarian spasial untuk ${infraName}...</p>`;

  try {
    // Cek apakah data infrastruktur sudah dimuat
    if (!infrastructureGeometries[selectedInfrastructure]) {
      // Muat data infrastruktur jika belum ada
      const loaded = await loadInfrastructureGeometries(selectedInfrastructure);
      if (!loaded) {
        return;
      }
    }

    const infraGeometries = infrastructureGeometries[selectedInfrastructure];
    
    // Konversi distance ke meter jika diperlukan
    const distanceInMeters = unit === 'kilometers' ? distance * 1000 : distance;
    console.log(`Jarak dalam meter: ${distanceInMeters}`);

    // Buat buffer dari semua geometri infrastruktur
    let allBuffers = [];
    
    infraGeometries.forEach((infraFeature, index) => {
      try {
        const infraGeometry = infraFeature.geometry;
        if (!infraGeometry) {
          console.warn(`${selectedInfrastructure} feature ${index} tidak memiliki geometri`);
          return;
        }
        
        console.log(`Processing ${selectedInfrastructure} ${index}, geometry type:`, infraGeometry.type);
        
        // Buat buffer untuk setiap infrastruktur
        const buffer = turf.buffer(infraGeometry, distanceInMeters, { units: 'meters' });
        if (buffer) {
          allBuffers.push(buffer);
        }
      } catch (error) {
        console.error(`Error processing ${selectedInfrastructure} ${index}:`, error);
      }
    });

    if (allBuffers.length === 0) {
      document.getElementById('info-table').innerHTML = 
        `<h3>Error:</h3><p>‚ùå Tidak dapat membuat buffer dari geometri ${infraName}</p>`;
      return;
    }

    console.log(`Berhasil membuat ${allBuffers.length} buffer untuk ${selectedInfrastructure}`);

    // Gabungkan semua buffer
    let combinedBuffer = allBuffers[0];
    for (let i = 1; i < allBuffers.length; i++) {
      try {
        const union = turf.union(combinedBuffer, allBuffers[i]);
        if (union) {
          combinedBuffer = union;
        }
      } catch (error) {
        console.warn(`Error union buffer ${i}:`, error);
      }
    }

    // Tampilkan buffer area di peta dengan warna berbeda berdasarkan infrastruktur
    const bufferColors = {
      'Jalan_Ngablak': '#ff0000',
      'Energi_Ngablak': '#ffaa00',
      'FO_Ngablak': '#00aaff',
      'Kesehatan_Ngablak': '#ff0080',
      'Pendidikan_Ngablak': '#8000ff',
      'Perdajas_Ngablak': '#00ff80',
      'Peribadatan_Ngablak': '#ff8000',
      'Drainase_Ngablak': '#0080ff',
      'Irigasi_Ngablak': '#80ff00'
    };
    
    const bufferColor = bufferColors[selectedInfrastructure] || '#ff0000';

    if (combinedBuffer) {
      const bufferGeoJSON = L.geoJSON(combinedBuffer, {
        style: {
          color: bufferColor,
          weight: 2,
          opacity: 0.8,
          fillColor: bufferColor,
          fillOpacity: 0.2
        }
      });
      bufferLayer.addLayer(bufferGeoJSON);
      console.log(`Buffer area ${selectedInfrastructure} ditampilkan di peta`);
    }

    // Ambil data bidang tanah (NGABLAK layer)
    console.log('Mengambil data bidang tanah...');
    const response = await fetch(`${geoserverUrl}/${workspace}/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${workspace}:NGABLAK&outputFormat=application/json&srsName=EPSG:4326`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const landData = await response.json();
    console.log('Raw land data:', landData);

    if (!landData.features || landData.features.length === 0) {
      document.getElementById('info-table').innerHTML = 
        `<h3>Info:</h3><p>‚ö†Ô∏è Tidak ada data bidang tanah ditemukan di layer NGABLAK</p>`;
      return;
    }

    console.log(`Memproses ${landData.features.length} bidang tanah`);

    // Filter bidang yang berada dalam buffer
    const filteredLands = [];
    landData.features.forEach((landFeature, index) => {
      try {
        const landGeometry = landFeature.geometry;
        
        if (combinedBuffer && landGeometry) {
          // Cek apakah bidang tanah bersinggungan dengan buffer area
          const intersection = turf.intersect(landGeometry, combinedBuffer);
          if (intersection) {
            filteredLands.push(landFeature);
            console.log(`Bidang ${index} memenuhi kriteria ${selectedInfrastructure}`);
          }
        }
      } catch (error) {
        console.warn(`Error processing land ${index}:`, error);
      }
    });

    console.log(`Ditemukan ${filteredLands.length} bidang yang memenuhi kriteria ${selectedInfrastructure}`);

    // Tampilkan hasil di peta
    if (filteredLands.length > 0) {
      const resultGeoJSON = L.geoJSON({
        type: "FeatureCollection",
        features: filteredLands
      }, {
        style: {
          color: '#00ff00',
          weight: 3,
          opacity: 1.0,
          fillColor: '#00ff00',
          fillOpacity: 0.4
        },
        onEachFeature: function(feature, layer) {
          // Tambahkan popup dengan informasi bidang
          if (feature.properties) {
            let popupContent = `<h4>Informasi Bidang</h4>`;
            popupContent += `<p><strong>Dekat dengan:</strong> ${infraName}</p>`;
            popupContent += `<p><strong>Jarak:</strong> ‚â§ ${distance} ${unit}</p><hr>`;
            Object.entries(feature.properties).forEach(([key, value]) => {
              popupContent += `<b>${key}:</b> ${value}<br>`;
            });
            layer.bindPopup(popupContent);
          }
        }
      });
      
      spatialSearchLayer.addLayer(resultGeoJSON);
      
      // Update info table dengan hasil
      let infoHtml = `<h3>Hasil Pencarian Spasial:</h3>`;
      infoHtml += `<p>‚úÖ Ditemukan <b>${filteredLands.length}</b> bidang dalam radius <b>${distance} ${unit}</b> dari <b>${infraName}</b>.</p>`;
      
      if (filteredLands.length > 0 && filteredLands[0].properties) {
        infoHtml += `<h4>Contoh Data Bidang:</h4><table><tr><th>Atribut</th><th>Nilai</th></tr>`;
        Object.entries(filteredLands[0].properties).forEach(([key, value]) => {
          infoHtml += `<tr><td>${key}</td><td>${value}</td></tr>`;
        });
        infoHtml += `</table>`;
        infoHtml += `<p><small>üí° Klik pada area hijau di peta untuk melihat detail bidang</small></p>`;
      }
      
      document.getElementById('info-table').innerHTML = infoHtml;
      
      // Zoom ke hasil pencarian
      map.fitBounds(resultGeoJSON.getBounds(), { padding: [20, 20] });
    } else {
      document.getElementById('info-table').innerHTML = 
        `<h3>Hasil Pencarian Spasial:</h3><p>‚ùå Tidak ada bidang ditemukan dalam radius ${distance} ${unit} dari ${infraName}.</p><p><small>üí° Coba perbesar jarak pencarian atau pastikan ada bidang tanah di sekitar ${infraName}</small></p>`;
    }

  } catch (error) {
    console.error('Error in infrastructure spatial search:', error);
    document.getElementById('info-table').innerHTML = 
      `<h3>Error:</h3><p>‚ùå Terjadi kesalahan: ${error.message}</p>`;
  }
}

// Event handlers untuk pencarian spasial infrastruktur
document.getElementById('spatial-search-btn').addEventListener('click', performInfrastructureSpatialSearch);
document.getElementById('distance-input').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') performInfrastructureSpatialSearch();
});
document.getElementById('clear-spatial-btn').addEventListener('click', function() {
  spatialSearchLayer.clearLayers();
  bufferLayer.clearLayers();
  document.getElementById('distance-input').value = '50';
  document.getElementById('distance-unit').value = 'meters';
  document.getElementById('infrastructure-select').value = '';
  document.getElementById('info-table').innerHTML = 
    "<h3>Informasi Atribut:</h3><p>Klik pada peta untuk melihat informasi atribut layer aktif.</p>";
});

// Event handler untuk perubahan pilihan infrastruktur
document.getElementById('infrastructure-select').addEventListener('change', function() {
  const selectedInfra = this.value;
  if (selectedInfra) {
    // Auto-adjust default distance based on infrastructure type
    const defaultDistances = {
      'Jalan_Ngablak': 50,
      'Energi_Ngablak': 100,
      'FO_Ngablak': 200,
      'Kesehatan_Ngablak': 500,
      'Pendidikan_Ngablak': 1000,
      'Perdajas_Ngablak': 300,
      'Peribadatan_Ngablak': 500,
      'Drainase_Ngablak': 100,
      'Irigasi_Ngablak': 200
    };
    
    const defaultDistance = defaultDistances[selectedInfra] || 50;
    document.getElementById('distance-input').value = defaultDistance;
    
    // Bersihkan hasil pencarian sebelumnya
    spatialSearchLayer.clearLayers();
    bufferLayer.clearLayers();
  }
});

</script>

<div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999;">
  <img src="https://i.imgur.com/llF5iyg.gif" alt="Loading..." width="60"/>
</div>
<script>
  function showLoading() {
    document.getElementById('loading-spinner').style.display = 'block';
  }

  function hideLoading() {
    document.getElementById('loading-spinner').style.display = 'none';
  }

  function logProcess(message) {
    const logDiv = document.getElementById('process-log');
    if (logDiv) {
      logDiv.innerHTML += `<p>üîπ ${message}</p>`;
    }
  }
</script>

</body>
</html>
